import{ni as I,nj as R,nk as F,nl as L,nm as x,ik as v,nn as G,no as A,np as f,a1 as D,aj as d,ak as p,am as M,at as $,aX as U,c$ as k,nq as V}from"./index-75797708.js";import{v as W,s as w}from"./rasterProjectionHelper-617ba3fc.js";import{l as J}from"./LayerView3D-77681ce3.js";import{p as Z}from"./TiledLayerView3D-77131e93.js";import{i as q}from"./timeSupport-88508996.js";import{p as H}from"./popupUtils-0412893d.js";import{y as Y}from"./LayerView-7059f1fc.js";import{i as Q}from"./RefreshableLayerView-710745d7.js";import{r as X}from"./drapedUtils-7f968a53.js";function K(r,e,t="nearest",i=!1){const s=!(i&&e.pixelType==="u8"),n=s?I.FLOAT:I.UNSIGNED_BYTE,h=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),m=r.capabilities.textureFloatLinear,a=new R;return a.width=e.width,a.height=e.height,a.internalFormat=s?F.RGBA32F:L.RGBA,a.samplingMode=!m||t!=="bilinear"&&t!=="cubic"?x.NEAREST:x.LINEAR,a.dataType=n,a.wrapMode=v.CLAMP_TO_EDGE,new G(r,a,h)}function ee(r,e){const{spacing:t,offsets:i,coefficients:s,size:[n,h]}=e,m=t[0]>1,a=new R;a.width=m?4*n:n,a.height=h,a.internalFormat=F.RGBA32F,a.dataType=I.FLOAT,a.samplingMode=x.NEAREST,a.wrapMode=v.CLAMP_TO_EDGE;const o=new Float32Array(m?n*h*16:2*i.length);if(m&&s!=null)for(let u=0,l=0;u<s.length;u++)o[l++]=s[u],u%3==2&&(o[l++]=1);else for(let u=0;u<h;u++)for(let l=0;l<n;l++){const c=4*(u*n+l),y=2*(l*h+u);o[c]=i[y],o[c+1]=i[y+1],o[c+3]=i[y]===-1?0:1}return new G(r,a,o)}function O(r,e){const t=new R;return t.internalFormat=L.RGBA,t.width=e.length/4,t.height=1,t.samplingMode=x.NEAREST,t.wrapMode=v.CLAMP_TO_EDGE,new G(r,t,e)}function te(r,e,t,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!r,u_opacity:i,u_transformSpacing:r?r.spacing:A,u_transformGridSize:r?r.size:A,u_targetImageSize:e,u_srcImageSize:t}}function re(r,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:r?r.length/4-1:0}}function ie(r){return{u_bandCount:r.bandCount,u_minOutput:r.outMin,u_maxOutput:r.outMax,u_minCutOff:r.minCutOff,u_maxCutOff:r.maxCutOff,u_factor:r.factor,u_useGamma:r.useGamma,u_gamma:r.gamma,u_gammaCorrection:r.gammaCorrection}}function se(r){return{u_hillshadeType:r.hillshadeType,u_sinZcosAs:r.sinZcosAs,u_sinZsinAs:r.sinZsinAs,u_cosZs:r.cosZs,u_weights:r.weights,u_factor:r.factor,u_minValue:r.minValue,u_maxValue:r.maxValue}}const C={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class ae{constructor(e,t,i=null,s=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=i||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=f(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...C,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||C}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((t,i)=>!!this._bandIds?.[i]&&t===this._bandIds[i])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?x.LINEAR:x.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=f(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=ee(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:s,opacity:n}=this,h=te(t,[i,s],[this.source.width,this.source.height],n),m=re(e.colormap,e.colormapOffset),a=this.symbolizerParameters.type==="stretch"?ie(this.symbolizerParameters):null,o=this.symbolizerParameters.type==="hillshade"?se(this.symbolizerParameters):null;return new D(h,m,a||o,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>t!=null?t.descriptor.width*t.descriptor.height*4:0).reduce((t,i)=>t+i,0)}return this._memoryUsed}release(){return this._rasterTexture=f(this._rasterTexture),this._transformGridTexture=f(this._transformGridTexture),this._colormapTexture=f(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i?.pixels&&i.pixels.length>0))return void(this._rasterTexture=f(this._rasterTexture));const s=t==null&&this.bandIds==null||t!=null&&this.bandIds!=null&&t.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&s)return;this._rasterTexture=f(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=K(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some((s,n)=>s!==t[n])?(this._colormapTexture=f(this._colormapTexture),this._colormapTexture=O(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=O(e,i),void(this._colormap=i)):(this._colormapTexture=f(this._colormapTexture),void(this._colormap=null))}}const ne=r=>{let e=class extends r{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}get timeExtent(){return q(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return W(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(t){return!!w(this.layer.serviceRasterInfo,t)}async fetchPopupFeaturesAtLocation(t,i){const{layer:s}=this;if(!t)throw new $("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,h=H(s,i);if(!n||h==null)return[];const m=[],{value:a,magdirValue:o,processedValue:u}=await s.identify(t,{timeExtent:this.timeExtent,signal:i?.signal});let l="";if(a?.length){l=s.type==="imagery-tile"&&s.hasStandardTime()&&a[0]!=null?a.map(b=>s.getStandardTimeValue(b)).join(", "):a.join(", ");const c={ObjectId:0},y="Raster.ServicePixelValue";c[y]=s.type==="imagery-tile"&&s.raster.datasetFormat==="Function"?u?.join(", "):l,c[y+".Raw"]=l;const z=s.raster?.rasterInfo??s.serviceRasterInfo,E=z?.attributeTable;if(E!=null){const{fields:b,features:N}=E,P=b.find(({name:g})=>g.toLowerCase()==="value"),B=c[y],T=P?N.find(g=>String(g.attributes[P.name])===B):null;if(T)for(const g in T.attributes)T.attributes.hasOwnProperty(g)&&(c[this._rasterFieldPrefix+g]=T.attributes[g])}const S=z?.dataType;S!=="vector-magdir"&&S!=="vector-uv"||(c["Raster.Magnitude"]=o?.[0],c["Raster.Direction"]=o?.[1]);const j=new U({geometry:this.fullExtent.clone(),attributes:c,layer:s,sourceLayer:s});m.push(j)}return m}_getfullExtent(){return w(this.layer.serviceRasterInfo,this.view.spatialReference)}};return d([p()],e.prototype,"fullExtent",null),d([p()],e.prototype,"layer",void 0),d([p({readOnly:!0})],e.prototype,"timeExtent",null),d([p()],e.prototype,"view",void 0),d([p()],e.prototype,"tileInfo",void 0),d([p({readOnly:!0})],e.prototype,"hasTilingEffects",null),d([p()],e.prototype,"datumTransformation",null),e=d([M("esri.views.layers.ImageryTileLayerView")],e),e};let _=class extends ne(Q(Z(J(Y)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new $("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const r=k(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t),this.tileInfo=this._isAlignedMapTile?t:e.toTileInfo(),this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(r)}destroy(){this.layer.decreaseRasterJobHandlerUsage()}get _blankTile(){const r=document.createElement("canvas"),e=r.getContext("2d"),[t,i]=this.tileInfo.size;return r.width=t,r.height=i,e.clearRect(0,0,t,i),e.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const r=this.layer.tileInfo,e=this.tileInfo.lodAt(0)?.scale,t=this.layer.tileInfo.lodAt(r.lods.length-1)?.scale;return this.levelRangeFromScaleRange(e,t)}_getfullExtent(){return w(this.layer.serviceRasterInfo,this.view.basemapTerrain?.spatialReference??this.view.spatialReference)}async fetchTile(r,e){const t=this.tileInfo,i=this._canSymbolizeInWebGL(),s={tileInfo:t,requestRawData:i,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,noClip:!1},{layer:n}=this,[h,m,a]=r,o=await n.fetchTile(h,m,a,s);if(o instanceof HTMLImageElement)return o;let u=o?.pixelBlock;if(u==null)return this._blankTile;if(!i&&(u=await n.applyRenderer(o),u==null))return this._blankTile;const l=new ae([h,m,a],u,t.size[0],t.size[1]);return i?(l.symbolizerRenderer=n.symbolizer.rendererJSON,l.symbolizerParameters=n.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(h)),l.transformGrid=o.transformGrid,l.bandIds=n.bandIds):(l.isRendereredSource=!0,l.bandIds=null),l.interpolation=n.interpolation,l}_getSymbolizerOptions(r){const e=this.tileInfo.lodAt(r).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(r){this._canSymbolizeInWebGL()&&JSON.stringify(r.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(r.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(r.lij[0])))}createFetchPopupFeaturesQueryGeometry(r,e){return X(r,e,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){const r=V(),{symbolizer:e}=this.layer,t=e.lookup?.colormapLut?.indexedColormap,i=!!this.layer.rasterFunction?.hasClipFunction,s=t&&t.length>4*(r.maxTextureSize||4906);return e.canRenderInWebGL&&!s&&!i}};d([p({readOnly:!0})],_.prototype,"_blankTile",null),d([p({readOnly:!0})],_.prototype,"imageFormatIsOpaque",null),d([p({readOnly:!0})],_.prototype,"hasMixedImageFormats",null),d([p({readOnly:!0})],_.prototype,"dataLevelRange",null),_=d([M("esri.views.3d.layers.ImageryTileLayerView3D")],_);const ye=_;export{ye as default};
