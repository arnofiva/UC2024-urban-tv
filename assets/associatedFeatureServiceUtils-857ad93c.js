import{aC as p,at as c,b2 as w,b3 as j,au as u,av as y,b4 as b}from"./index-b9c5f9ae.js";async function C(r,n){const t=p(r);if(!t)throw new c("invalid-url","Invalid scene service url");const e={...n,sceneServerUrl:t.url.path,layerId:t.sublayer??void 0};if(e.sceneLayerItem??(e.sceneLayerItem=await D(e)),e.sceneLayerItem==null)return m(e.sceneServerUrl.replace("/SceneServer","/FeatureServer"),e);const a=await T(e);if(!a?.url)throw new c("related-service-not-found","Could not find feature service through portal item relationship");e.featureServiceItem=a;const l=await m(a.url,e);return l.portalItem=a,l}async function D(r){const n=(await h(r)).serviceItemId;if(!n)return null;const t=new w({id:n,apiKey:r.apiKey}),e=await A(r);e!=null&&(t.portal=new j({url:e}));try{return t.load({signal:r.signal})}catch(a){return u(a),null}}async function h(r){if(r.rootDocument)return r.rootDocument;const n={query:{f:"json",...r.customParameters,token:r.apiKey},responseType:"json",signal:r.signal};try{const t=await y(r.sceneServerUrl,n);r.rootDocument=t.data}catch{r.rootDocument={}}return r.rootDocument}async function A(r){const n=b?.findServerInfo(r.sceneServerUrl);if(n?.owningSystemUrl)return n.owningSystemUrl;const t=r.sceneServerUrl.replace(/(.*\/rest)\/.*/i,"$1")+"/info";try{const e=(await y(t,{query:{f:"json"},responseType:"json",signal:r.signal})).data.owningSystemUrl;if(e)return e}catch(e){u(e)}return null}async function m(r,n){const t=p(r);if(!t)throw new c("invalid-feature-service-url","Invalid feature service url");const e=t.url.path,a=n.layerId;if(a==null)return{serverUrl:e};const l=h(n),f=n.featureServiceItem?await n.featureServiceItem.fetchData("json"):null,S=(f?.layers?.[0]||f?.tables?.[0])?.customParameters,d=s=>{const U={query:{f:"json",...S},responseType:"json",authMode:s,signal:n.signal};return y(e,U)},g=d("anonymous").catch(()=>d("no-prompt")),[v,I]=await Promise.all([g,l]),o=I?.layers,i=v.data&&v.data.layers;if(!Array.isArray(i))throw new Error("expected layers array");if(Array.isArray(o)){for(let s=0;s<Math.min(o.length,i.length);s++)if(o[s].id===a)return{serverUrl:e,layerId:i[s].id}}else if(a!=null&&a<i.length)return{serverUrl:e,layerId:i[a].id};throw new Error("could not find matching associated sublayer")}async function T({sceneLayerItem:r,signal:n}){if(!r)return null;try{const t=(await r.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:n})).find(a=>a.type==="Feature Service")||null;if(!t)return null;const e=new w({portal:t.portal,id:t.id});return await e.load(),e}catch(t){return u(t),null}}export{C as s};
